const supabase = window.supabase.createClient(
  window.DVK_SUPABASE_URL,
  window.DVK_SUPABASE_ANON_KEY
);

const btn = document.getElementById("btn");
const codeInput = document.getElementById("code");
const result = document.getElementById("result");

function renderError(msg) {
  result.innerHTML = `
    <strong>Status</strong>
    <div class="badge bad">${msg}</div>
    <p class="small" style="margin-top:8px">Controleer de code en probeer opnieuw.</p>
  `;
}

function renderOk(status, note) {
  const badge =
    status === "delivered" ? "ok" :
    status === "en_route" ? "warn" :
    status === "picked_up" ? "warn" :
    status === "created" ? "" : "";

  const label =
    status === "delivered" ? "Afgeleverd" :
    status === "en_route" ? "Onderweg" :
    status === "picked_up" ? "Opgehaald" :
    status === "created" ? "Aangemeld" : status;

  result.innerHTML = `
    <strong>Status</strong>
    <div class="badge ${badge}">${label}</div>
    <p class="small" style="margin-top:8px">${note || ""}</p>
  `;
}

async function lookupTrack(code) {
  const { data: shipment, error } = await supabase
    .from("shipments")
    .select("id, status")
    .eq("track_code", code)
    .maybeSingle();

  if (error) return renderError("Fout bij ophalen");
  if (!shipment) return renderError("Onbekende trackcode");

  const { data: events } = await supabase
    .from("shipment_events")
    .select("note, created_at")
    .eq("shipment_id", shipment.id)
    .order("created_at", { ascending: false })
    .limit(1);

  renderOk(shipment.status, events?.[0]?.note || "Status bijgewerkt.");
}

btn?.addEventListener("click", () => {
  const code = (codeInput?.value || "").trim().toUpperCase();
  if (!code) return renderError("Voer een trackcode in");
  lookupTrack(code);
});
